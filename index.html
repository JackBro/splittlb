<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>TLB Splitting with Intel vt-d and KVM  by nick-kvmhv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">TLB Splitting with Intel vt-d and KVM </h1>
      <h2 class="project-tagline">TLB Splitting with Intel vt-d and KVM </h2>
      <a href="https://github.com/nick-kvmhv/splittlb" class="btn">View on GitHub</a>
      <a href="https://github.com/nick-kvmhv/splittlb/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/nick-kvmhv/splittlb/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="tlb-split-in-kvm" class="anchor" href="#tlb-split-in-kvm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>TLB Split in KVM</h1>

<p>This project adds TLB splitting functionality to KVM hypervisor, available with Linux kernel. It includes the following components:</p>

<ul>
<li>Kernel patches and TLB split implementation for KVM</li>
<li>Test application</li>
<li>Monitor application<br>
</li>
</ul>

<h2>
<a id="kernel-patches-and-tlb-split-implementation-for-kvm" class="anchor" href="#kernel-patches-and-tlb-split-implementation-for-kvm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Kernel patches and TLB split implementation for KVM</h2>

<p>Kernel patches can be found in the root folder, they add calls to the functions, defined in tlbsplit.c, to several KVM files<br>
To build a kernel with TLB split support<br>
1. Copy 2 files from arch/x86/kvm to the same folder in the kernel source tree<br>
2. Apply all patches that can be found in the root folder of the repository (kvm_host.h.patch kvm_main.c.patch  Makefile.patch mmu.c.patch mmu.h.patch vmx.c.patch). These patches were made against Ubuntu kernel 3.19.0 and might require some adjustments for other versions.<br>
3. Build the kernel using its build script   </p>

<h2>
<a id="test-application" class="anchor" href="#test-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Test application</h2>

<p>Test application is created using Visual C++ 2012. To build it either import it to VC++ or use msbuild on its project file.<br>
The application uses minhook library from <a href="https://github.com/TsudaKageyu/minhook">here</a> . It can run three different commands:</p>

<ul>
<li>VMCallTest /once 
This is the default command option, VMCallTest will alter its own code while protecting the page it is changing so that the value that can be read stays unchanged. It will then execute the modified code once and print two values: the value in the instruction body (that is changed) and the value that can be read from the same memory location (where the change is hidden by TLB Split).</li>
<li>VMCallTest /many 
Similar to /once but it will read the value multiple times. This can be used to track the number of page faults in the hypervisor log. In my observation it does not generate any additional page faults for multiple reads unless you have some print instructions between them. The print instruction will effectively flush the TLB because it makes a system call and accesses a lot of pages for this.</li>
<li>VMCallTest /hook
The application will hook IsDebuggerPresent function from Windows API and make it return 1. It will hide the patched code  under a split page. </li>
</ul>

<h2>
<a id="monitor-application" class="anchor" href="#monitor-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Monitor application</h2>

<p>Monitor application can be used in the hypervisor linux command prompt to periodically poll for some statistics about split pages that are being accessed for reading. It prints data such as RIP, Guest virtual address and CR3 value for the instruction that initiated a page flip.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/nick-kvmhv/splittlb">TLB Splitting with Intel vt-d and KVM </a> is maintained by <a href="https://github.com/nick-kvmhv">nick-kvmhv</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
